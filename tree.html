<!DOCTYPE html>
<html>
    <head>
	<meta charset="UTF-8">
	<title>D3 tree layout</title>

	<!-- d3 -->
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>

	<!-- font awesome -->
	<script src="https://use.fontawesome.com/9a30fbcc62.js"></script>

    </head>

    <body>
	<i class="fa fa-sitemap"></i>
	<i class="fa fa-code-fork fa-rotate-180"></i>

	<script type="text/javascript">

         var width = 1200;
	 var height = 700;

	 var svg = d3.select("body").append("svg")
		     .attr("width", width)
		     .attr("height", height)
		     .append("g")
		     .attr("transform", "translate(10,50)");//ここがツリーの左上になる。

	 var tree = d3.layout.tree()
		      .size([400, 600]) // .size()でツリー全体のサイズを決める。
		      .children(children)
		      .sort(comparator);

	 var tip = d3.tip()
		     .attr('class', 'd3-tip')
		     .offset([-10, 0])
		     .html(function(d) {
			 if (d.name == "Seq Scan") {

			     var tooltip = ""
			     for (key in d) {
				 console.log(`${key} : ${d[key]}`)
				 tooltip += `${key} : ${d[key]} <br>`;
			     }

			     return tooltip;
			 }
			 else if (d.name == "Index Scan")
			     return '<i class="fa fa-sitemap"> ' + d["Relation Name"] + '</i>'
			 else if (d.name == "Sort")
			     return '<i class="fa fa-sort-amount-asc"></i>'
			 else if (d.name == "Hash")
			     return '<i class="fa fa-hashtag"></i>'
			 else if (d.name == "Hash Join")
			     return '<i class="fa fa-code-fork"></i>'
			 else if (d.name == "Nested Loop")
			     return '<i class="fa fa-code-fork"></i>'
			 else if (d.name == "Aggregate")
			     return '<i class="fa fa-object-group"></i>'
			 else if (d.name == "Limit")
			     return '<i class="fa fa-cut"></i>'

			 else
		             return `<span>${d.name}</span>`;

		     })

	 svg.call(tip);

	 function children(d) {
	     return d["Plans"];
	 }

	 function comparator(a, b) {
	     if (a["Parent Relationship"] == "Inner") {
		 return -1;
	     } else {
		 return 1;
	     }
	 }

	 // not used
	 function traverse(o, func) {
	     for (var i in o) {
	         func.apply(this, [i, o[i]]);
	         if (o[i] !==  null && typeof(o[i]) == "object") {
		     //going on step down in the object tree!!
		     traverse(o[i], func);
		 }
	     }
	 }

	 d3.json("api/q9", (err, data) => {

	     var obj = data[0]["QUERY PLAN"][0]["Plan"];
	     var renamedObj = JSON.parse(JSON.stringify(obj).split('"Node Type":').join('"name":'));

	     // tree.nodesで、childrenのname分だけ、name/children/parent/depth/x/yを作る。
	     var nodes = tree.nodes(renamedObj);
	     nodes.forEach( d => {
		 d.x = d.x * 2.5;
		 d.y = d.y + 30;
	     })

	     // nodesから、diagonal用データ構造を作る
	     var links = tree.links(nodes);

	     var diagonal = d3.svg.diagonal();

	     //linksで作ったsource、targetでdiagonal曲線を作る。
	     svg.selectAll(".link")
	        .data(links)
	        .enter()
	        .append("path")
	        .attr("class", "link")
	        .attr("fill", "none")
	        .attr("stroke", "gray")
	        .attr("d", diagonal);

	     // 円とテキストを入れるノードのコンテナg。
	     var node = svg.selectAll(".node")
			   .data(nodes) //nodesの数分gを作る。
			   .enter()
			   .append("g")
			   .attr("class", "node")
			   .attr("transform", d => { return "translate("+ d.x + "," + d.y + ")";})

//	     node.append("text")
//	         .text(d => {return d.name} )
//	         .attr("x", 0)
//		 .attr("y", 0)

	     node.append("circle")
		 .attr("r", 20)
		 .on('mouseover', tip.show)
		 .on('mouseout', tip.hide);

	     // It seems that foreringObject and tooltip are less compatible each other.
	     // Maybe I sholud use combination of normal svg text object, CSS and unicode to display Iconfont.
	     node.append('svg:foreignObject')
	         .attr('x', -20)
	         .attr('y', -20)
	         .append("xhtml:body")
	         .html( d => {

		     if (d.name == "Seq Scan")
			 return '<i class="fa fa-table"> ' + d["Relation Name"] + '</i>'
		     else if (d.name == "Index Scan")
			 return '<i class="fa fa-sitemap"> ' + d["Relation Name"] + '</i>'

		     else if (d.name == "Sort")
			 return '<i class="fa fa-sort-amount-asc"></i>'
		     else if (d.name == "Hash")
			 return '<i class="fa fa-hashtag"></i>'
		     else if (d.name == "Hash Join")
			 return '<i class="fa fa-code-fork"></i>'
		     else if (d.name == "Nested Loop")
			 return '<i class="fa fa-code-fork"></i>'

		     else if (d.name == "Aggregate")
			 return '<i class="fa fa-object-group"></i>'

		     else if (d.name == "Limit")
			 return '<i class="fa fa-cut"></i>'

		     else
			 return d.name;
		 });

	 });

	</script>

	<style>
	 .node circle {
	     fill: #9999FF;
	 }

	 .d3-tip {
	     line-height: 1;
	     font-weight: bold;
	     padding: 12px;
	     background: rgba(99, 99, 99, 0.8);
	     color: #fff;
	     border-radius: 10px;
	 }

	 /* Creates a small triangle extender for the tooltip */
	 .d3-tip:after {
	     box-sizing: border-box;
	     display: inline;
	     font-size: 10px;
	     width: 100%;
	     line-height: 1;
	     color: rgba(0, 0, 0, 0.8);
	     content: "\25BC";
	     position: absolute;
	     text-align: center;
	 }

	 /* Style northward tooltips differently */
	 .d3-tip.n:after {
	     margin: -1px 0 0 0;
	     top: 100%;
	     left: 0;
	 }
	</style>

    </Body>
</html>
