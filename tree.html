<!DOCTYPE html>
<html>
    <head>
	<meta charset="UTF-8">
	<title>D3 tree layout</title>

	<!-- d3 -->
	<script src="http://d3js.org/d3.v3.min.js"></script>
    </head>

    <body>
	<script type="text/javascript">

         var width = 450;
	 var height = 700;

	 var svg = d3.select("body").append("svg")
		     .attr("width", width)
		     .attr("height", height)
		     .attr("transform", "translate(10,50)");//ここがツリーの左上になる。

	 var tree = d3.layout.tree()
		      .size([400, 600]) // .size()でツリー全体のサイズを決める。
		      .children(children)
		      .sort(comparator);

	 function children(d) {
	     return d["Plans"];
	 }

	 function comparator(a, b) {
	     if (a["Parent Relationship"] == "Inner") {
		 return -1;
	     } else {
		 return 1;
	     }
	 }


	 function traverse(o, func) {
	     for (var i in o) {
	         func.apply(this, [i, o[i]]);
	         if (o[i] !==  null && typeof(o[i]) == "object") {
		     //going on step down in the object tree!!
		     traverse(o[i], func);
		 }
	     }
	 }

	 d3.json("api/q8", function(err, data) {

	     var obj = data[0]["QUERY PLAN"][0]["Plan"];
	     var renamedObj = JSON.parse(JSON.stringify(obj).split('"Node Type":').join('"name":'));


	     // tree.nodesで、childrenのname分だけ、name/children/parent/depth/x/yを作る。
	     var nodes = tree.nodes(renamedObj);

	     // nodesから、diagonal用データ構造を作る
	     var links = tree.links(nodes);


	     // 円とテキストを入れるノードのコンテナg。
	     var node = svg.selectAll(".node")
			   .data(nodes) //nodesの数分gを作る。
			   .enter()
			   .append("g")
			   .attr("class", "node")
			   .attr("transform", function(d){ return "translate("+ d.x + "," + (d.y + 30) + ")";});

	     node.append("circle")
	         .attr("r", 10)
	         .attr("fill", "steelblue");

	     node.append("text")
	         .text(function(d) { return d.name})
	         .attr("x", 5)
		 .attr("y", 5)

	     var diagonal = d3.svg.diagonal()
			      .projection(function(d){ return [d.x, d.y + 30];}); // 横向きにするためにxとyを逆に。

	     //linksで作ったsource、targetでdiagonal曲線を作る。
	     svg.selectAll(".link")
	        .data(links)
	        .enter()
	        .append("path")
	        .attr("class", "link")
	        .attr("fill", "none")
	        .attr("stroke", "gray")
	        .attr("d", diagonal);

	 });


	</script>

    </Body>
</html>
